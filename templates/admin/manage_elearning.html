{% extends "base.html" %}

{% block title %}Manage E-Learning - Admin Dashboard{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="admin-header bg-primary text-white py-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h3 mb-1">
                    <i class="fas fa-book-open me-2"></i>
                    E-Learning Resources Management
                </h1>
                <p class="mb-0">Upload and manage study materials, papers, and videos for Forms 1-4</p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{{ url_for('dashboard') }}" class="btn btn-light">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Add Resource Form -->
<section class="py-4">
    <div class="container">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-plus me-2"></i>
                            Add New E-Learning Resource
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data" id="resource-form">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="title" class="form-label fw-bold">Resource Title *</label>
                                    <input type="text" class="form-control" id="title" name="title" required
                                           placeholder="e.g., Form 1 Mathematics Past Paper 2024">
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="resource_type" class="form-label fw-bold">Resource Type *</label>
                                    <select class="form-select" id="resource_type" name="resource_type" required>
                                        <option value="">Select Type</option>
                                        <option value="file">File Upload (PDF/Document/Video)</option>
                                        <option value="youtube">YouTube Video Link</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="form" class="form-label fw-bold">Form/Class *</label>
                                    <select class="form-select" id="form" name="form" required>
                                        <option value="">Select Form</option>
                                        {% for form in forms %}
                                            <option value="{{ form }}">{{ form }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="subject" class="form-label fw-bold">Subject *</label>
                                    <select class="form-select" id="subject" name="subject" required>
                                        <option value="">Select Subject</option>
                                        {% for subject in subjects %}
                                            <option value="{{ subject }}">{{ subject }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="col-12 mb-3">
                                    <label for="description" class="form-label fw-bold">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"
                                              placeholder="Brief description of the resource content"></textarea>
                                </div>
                                
                                <!-- File Upload Section -->
                                <div class="col-12 mb-3" id="file-upload-section" style="display: none;">
                                    <label for="file" class="form-label fw-bold">Select File</label>
                                    <input type="file" class="form-control" id="file" name="file">
                                    <div class="form-text">
                                        <strong>Documents:</strong> PDF, DOC, DOCX (Max: 50MB)<br>
                                        <strong>Videos:</strong> MP4, AVI, MOV, WMV (Max: 50MB)
                                    </div>
                                </div>
                                
                                <!-- YouTube URL Section -->
                                <div class="col-12 mb-3" id="youtube-url-section" style="display: none;">
                                    <label for="youtube_url" class="form-label fw-bold">YouTube URL</label>
                                    <input type="url" class="form-control" id="youtube_url" name="youtube_url"
                                           placeholder="https://www.youtube.com/watch?v=...">
                                    <div class="form-text">Enter the full YouTube video URL</div>
                                </div>
                                
                                <div class="col-12 text-center">
                                    <button type="submit" class="btn btn-success btn-lg px-5">
                                        <i class="fas fa-upload me-2"></i>Add Resource
                                    </button>
                                    <button type="reset" class="btn btn-secondary btn-lg px-5 ms-3">
                                        <i class="fas fa-redo me-2"></i>Reset Form
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Resources List -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-12 mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <h3>
                        <i class="fas fa-list text-primary me-2"></i>
                        All E-Learning Resources
                        {% if resources %}
                            <span class="badge bg-primary">{{ resources|length }}</span>
                        {% endif %}
                    </h3>
                    
                    <!-- Filter Controls -->
                    <div class="d-flex gap-2 flex-wrap">
                        <select class="form-select form-select-sm" id="filter-form" style="width: auto;">
                            <option value="">All Forms</option>
                            {% for form in forms %}
                                <option value="{{ form }}">{{ form }}</option>
                            {% endfor %}
                        </select>
                        
                        <select class="form-select form-select-sm" id="filter-subject" style="width: auto;">
                            <option value="">All Subjects</option>
                            {% for subject in subjects %}
                                <option value="{{ subject }}">{{ subject }}</option>
                            {% endfor %}
                        </select>
                        
                        <select class="form-select form-select-sm" id="filter-type" style="width: auto;">
                            <option value="">All Types</option>
                            <option value="file">Files</option>
                            <option value="youtube">YouTube Videos</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        {% if resources %}
            <div class="row" id="resources-grid">
                {% for resource in resources %}
                    <div class="col-lg-4 col-md-6 mb-4 resource-item" 
                         data-form="{{ resource.form }}" 
                         data-subject="{{ resource.subject }}" 
                         data-type="{{ resource.resource_type }}">
                        <div class="card resource-admin-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center
                                        {% if resource.resource_type == 'file' %}bg-primary text-white{% else %}bg-danger text-white{% endif %}">
                                <div>
                                    <small class="opacity-75">{{ resource.form }} - {{ resource.subject }}</small>
                                </div>
                                <span class="badge {% if resource.resource_type == 'file' %}bg-light text-primary{% else %}bg-light text-danger{% endif %}">
                                    {% if resource.resource_type == 'file' %}
                                        <i class="fas fa-file-alt me-1"></i>File
                                    {% else %}
                                        <i class="fab fa-youtube me-1"></i>YouTube
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="card-body">
                                <h6 class="card-title">{{ resource.title }}</h6>
                                
                                {% if resource.description %}
                                    <p class="card-text text-muted small mb-3">
                                        {{ resource.description[:100] }}{% if resource.description|length > 100 %}...{% endif %}
                                    </p>
                                {% endif %}
                                
                                <div class="resource-info mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-light text-dark">{{ resource.form }}</span>
                                        <span class="badge bg-light text-dark">{{ resource.subject }}</span>
                                    </div>
                                    
                                    {% if resource.resource_type == 'file' and resource.filename %}
                                        <div class="file-info">
                                            <small class="text-muted">
                                                <i class="fas fa-file me-1"></i>
                                                {{ resource.filename.split('.')[-1].upper() }} File
                                            </small>
                                        </div>
                                    {% elif resource.resource_type == 'youtube' and resource.youtube_url %}
                                        <div class="youtube-info">
                                            <small class="text-muted">
                                                <i class="fab fa-youtube me-1"></i>
                                                YouTube Video
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="resource-actions">
                                    {% if resource.resource_type == 'file' and resource.filename %}
                                        {% if resource.filename.endswith(('.pdf', '.doc', '.docx')) %}
                                            <a href="{{ url_for('papers_file', filename=resource.filename) }}" 
                                               class="btn btn-outline-primary btn-sm me-2" target="_blank">
                                                <i class="fas fa-download me-1"></i>Preview
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('videos_file', filename=resource.filename) }}" 
                                               class="btn btn-outline-primary btn-sm me-2" target="_blank">
                                                <i class="fas fa-play me-1"></i>Play
                                            </a>
                                        {% endif %}
                                    {% elif resource.resource_type == 'youtube' and resource.youtube_url %}
                                        <a href="{{ resource.youtube_url }}" 
                                           class="btn btn-outline-danger btn-sm me-2" target="_blank">
                                            <i class="fab fa-youtube me-1"></i>Watch
                                        </a>
                                    {% endif %}
                                    
                                    <a href="{{ url_for('delete_elearning', resource_id=resource.id) }}" 
                                       class="btn btn-danger btn-sm"
                                       onclick="return confirm('Are you sure you want to delete this resource?')">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </a>
                                </div>
                            </div>
                            
                            <div class="card-footer bg-light">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    Uploaded {{ resource.date_uploaded.strftime('%b %d, %Y') }}
                                </small>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center text-muted py-5" id="empty-state">
                <i class="fas fa-book-open fa-4x mb-3"></i>
                <h3>No E-Learning Resources</h3>
                <p>Add your first learning resource using the form above.</p>
            </div>
        {% endif %}
    </div>
</section>

<!-- Quick Actions -->
<section class="py-4 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="mb-3">Quick Actions</h5>
                        <div class="d-flex justify-content-center gap-3 flex-wrap">
                            <a href="{{ url_for('elearning') }}" target="_blank" class="btn btn-outline-primary">
                                <i class="fas fa-eye me-2"></i>View Public E-Learning Page
                            </a>
                            <button type="button" class="btn btn-outline-success" onclick="window.scrollTo(0,0)">
                                <i class="fas fa-plus me-2"></i>Add Another Resource
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-tachometer-alt me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block head %}
<style>
.admin-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.resource-admin-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.resource-admin-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.form-control:focus, .form-select:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40,167,69,0.25);
}

.btn-success {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    border: none;
}

.btn-success:hover {
    background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
    transform: translateY(-1px);
}

.resource-info .badge {
    font-size: 0.7rem;
}

.resource-actions {
    border-top: 1px solid #eee;
    padding-top: 15px;
}

.resource-item {
    transition: opacity 0.3s ease;
}

.resource-item.hidden {
    display: none;
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const resourceTypeSelect = document.getElementById('resource_type');
    const fileUploadSection = document.getElementById('file-upload-section');
    const youtubeUrlSection = document.getElementById('youtube-url-section');
    const fileInput = document.getElementById('file');
    const youtubeInput = document.getElementById('youtube_url');

    // Toggle sections based on resource type
    resourceTypeSelect.addEventListener('change', function() {
        const value = this.value;
        
        if (value === 'file') {
            fileUploadSection.style.display = 'block';
            youtubeUrlSection.style.display = 'none';
            fileInput.required = true;
            youtubeInput.required = false;
            youtubeInput.value = '';
        } else if (value === 'youtube') {
            fileUploadSection.style.display = 'none';
            youtubeUrlSection.style.display = 'block';
            fileInput.required = false;
            youtubeInput.required = true;
            fileInput.value = '';
        } else {
            fileUploadSection.style.display = 'none';
            youtubeUrlSection.style.display = 'none';
            fileInput.required = false;
            youtubeInput.required = false;
        }
    });

    // File validation
    fileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            // Validate file size (50MB)
            if (file.size > 50 * 1024 * 1024) {
                alert('File size is too large. Please select a file smaller than 50MB.');
                this.value = '';
                return;
            }
            
            // Validate file type
            const allowedTypes = [
                'application/pdf', 'application/msword', 
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'video/mp4', 'video/avi', 'video/quicktime', 'video/x-ms-wmv'
            ];
            
            if (!allowedTypes.includes(file.type)) {
                alert('Please select a valid file type (PDF, DOC, DOCX, MP4, AVI, MOV, WMV).');
                this.value = '';
                return;
            }
        }
    });

    // YouTube URL validation
    youtubeInput.addEventListener('blur', function() {
        const url = this.value;
        if (url && !isValidYouTubeUrl(url)) {
            alert('Please enter a valid YouTube URL.');
            this.focus();
        }
    });

    function isValidYouTubeUrl(url) {
        const regex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+$/;
        return regex.test(url);
    }

    // Filter functionality
    const filterForm = document.getElementById('filter-form');
    const filterSubject = document.getElementById('filter-subject');
    const filterType = document.getElementById('filter-type');
    
    function filterResources() {
        const formValue = filterForm.value;
        const subjectValue = filterSubject.value;
        const typeValue = filterType.value;
        const resourceItems = document.querySelectorAll('.resource-item');
        
        resourceItems.forEach(item => {
            const itemForm = item.dataset.form;
            const itemSubject = item.dataset.subject;
            const itemType = item.dataset.type;
            
            const formMatch = !formValue || itemForm === formValue;
            const subjectMatch = !subjectValue || itemSubject === subjectValue;
            const typeMatch = !typeValue || itemType === typeValue;
            
            if (formMatch && subjectMatch && typeMatch) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    filterForm.addEventListener('change', filterResources);
    filterSubject.addEventListener('change', filterResources);
    filterType.addEventListener('change', filterResources);

    // Auto-populate title based on form and subject selection
    const formSelect = document.getElementById('form');
    const subjectSelect = document.getElementById('subject');
    const titleInput = document.getElementById('title');
    
    function updateTitle() {
        const form = formSelect.value;
        const subject = subjectSelect.value;
        
        if (form && subject && !titleInput.value) {
            titleInput.value = `${form} ${subject} Resource`;
        }
    }
    
    formSelect.addEventListener('change', updateTitle);
    subjectSelect.addEventListener('change', updateTitle);
});
</script>
{% endblock %}
