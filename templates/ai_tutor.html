{% extends "base.html" %}

{% block title %}AI Tutor - Gachororo Secondary School{% endblock %}

{% block head %}
<style>
    .chat-container {
        max-height: 70vh;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 15px;
        padding: 20px;
        background: linear-gradient(145deg, #ffffff 0%, var(--school-bg-light) 100%);
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .message {
        margin-bottom: 20px;
        max-width: 85%;
        position: relative;
        animation: messageSlideIn 0.3s ease-out;
    }
    
    @keyframes messageSlideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .user-message {
        margin-left: auto;
        text-align: right;
    }
    
    .user-message .message-content {
        background: linear-gradient(135deg, var(--school-primary) 0%, var(--school-secondary) 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 20px 20px 5px 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: inline-block;
        max-width: 100%;
    }
    
    .ai-message {
        margin-right: auto;
    }
    
    .ai-message .message-content {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        color: #2d3748;
        padding: 20px;
        border-radius: 20px 20px 20px 5px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        line-height: 1.6;
    }
    
    .step-item {
        display: flex;
        align-items: flex-start;
        margin: 12px 0;
        padding: 12px;
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        border-radius: 10px;
        border-left: 4px solid var(--school-primary);
    }
    
    .step-number {
        background: var(--school-primary);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        margin-right: 12px;
        flex-shrink: 0;
    }
    
    .step-content {
        flex: 1;
        font-weight: 500;
    }
    
    .bullet-item {
        display: flex;
        align-items: flex-start;
        margin: 8px 0;
        padding: 8px 12px;
    }
    
    .bullet-icon {
        color: var(--school-primary);
        font-size: 0.6rem;
        margin-right: 12px;
        margin-top: 6px;
        flex-shrink: 0;
    }
    
    .bullet-content {
        flex: 1;
    }
    
    .math-expression {
        background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
        color: #234e52;
        padding: 3px 8px;
        border-radius: 6px;
        font-family: 'Monaco', 'Consolas', monospace;
        border: 1px solid #81e6d9;
    }
    
    .formula {
        background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%);
        color: #9c4221;
        padding: 4px 8px;
        border-radius: 6px;
        font-family: 'Monaco', 'Consolas', monospace;
        border: 1px solid #fdba74;
        font-size: 0.95rem;
    }
    
    .fraction {
        font-family: 'Times New Roman', serif;
        font-size: 1.1rem;
        color: var(--school-primary);
        font-weight: 600;
    }
    
    .response-header {
        color: var(--school-primary);
        font-weight: 700;
        margin: 16px 0 8px 0;
        padding-bottom: 4px;
        border-bottom: 2px solid var(--school-primary);
        display: inline-block;
    }
    
    .paragraph {
        margin: 12px 0;
        line-height: 1.7;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: #a0aec0;
        margin-top: 8px;
        text-align: right;
    }
    
    .user-message .message-time {
        color: rgba(255,255,255,0.7);
    }
    
    .message-image {
        margin-bottom: 10px;
    }
    
    .image-preview {
        max-width: 250px;
        max-height: 250px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 2px solid #e2e8f0;
    }
    
    .typing-indicator {
        display: none;
        padding: 15px 20px;
        font-style: italic;
        color: #666;
        background: #f7fafc;
        border-radius: 20px;
        margin: 10px 0;
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 1; }
    }
    
    .subject-btn {
        transition: all 0.3s ease;
        border-radius: 25px;
        font-weight: 500;
    }
    
    .subject-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .card {
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .card-header {
        border-radius: 15px 15px 0 0 !important;
        background: linear-gradient(135deg, var(--school-primary) 0%, var(--school-secondary) 100%);
    }
</style>
{% endblock %}

{% block content %}
<section class="py-minimal">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-4">
                    <h2><i class="fas fa-robot me-2"></i>AI Tutor</h2>
                    <p class="lead-compact">Ask questions about your studies and get instant help from our AI tutor!</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mx-auto">
                <!-- Chat Container -->
                <div class="chat-container mb-4" id="chat-container">
                    <div class="text-center text-muted">
                        <i class="fas fa-graduation-cap fa-3x mb-3"></i>
                        <p>Welcome to your AI Study Assistant!</p>
                        <p>Ask me questions about Mathematics, Science, English, History, and more. You can also upload images for analysis.</p>
                    </div>
                </div>

                <!-- Input Form -->
                <div class="card">
                    <div class="card-body">
                        <form id="question-form" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="question" class="form-label">Your Question</label>
                                <textarea class="form-control" id="question" name="question" rows="3" 
                                          placeholder="Ask me about any school subject..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="image" class="form-label">Upload Image (Optional)</label>
                                <input type="file" class="form-control" id="image" name="image" accept="image/*">
                                <small class="text-muted">Upload diagrams, problems, or any educational content for analysis</small>
                                <div id="image-preview-container"></div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <button type="submit" class="btn btn-primary" id="submit-btn">
                                    <i class="fas fa-paper-plane me-2"></i>Ask AI Tutor
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="clear-chat">
                                    <i class="fas fa-eraser me-2"></i>Clear Chat
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Subject Suggestions -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Quick Subject Access</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm subject-btn" data-subject="Mathematics">
                                        <i class="fas fa-calculator me-2"></i>Mathematics
                                    </button>
                                    <button class="btn btn-outline-success btn-sm subject-btn" data-subject="Science">
                                        <i class="fas fa-flask me-2"></i>Science
                                    </button>
                                    <button class="btn btn-outline-info btn-sm subject-btn" data-subject="English">
                                        <i class="fas fa-book me-2"></i>English
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-warning btn-sm subject-btn" data-subject="History">
                                        <i class="fas fa-landmark me-2"></i>History
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm subject-btn" data-subject="Geography">
                                        <i class="fas fa-globe me-2"></i>Geography
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm subject-btn" data-subject="Kiswahili">
                                        <i class="fas fa-language me-2"></i>Kiswahili
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('question-form');
    const chatContainer = document.getElementById('chat-container');
    const questionInput = document.getElementById('question');
    const imageInput = document.getElementById('image');
    const submitBtn = document.getElementById('submit-btn');
    const clearBtn = document.getElementById('clear-chat');
    const imagePreviewContainer = document.getElementById('image-preview-container');

    // Handle image preview
    imageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreviewContainer.innerHTML = `
                    <div class="mt-2">
                        <img src="${e.target.result}" class="image-preview" alt="Preview">
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearImagePreview()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }
    });

    // Subject buttons
    document.querySelectorAll('.subject-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const subject = this.dataset.subject;
            questionInput.value = `I need help with ${subject}. `;
            questionInput.focus();
        });
    });

    // Clear chat
    clearBtn.addEventListener('click', function() {
        chatContainer.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-graduation-cap fa-3x mb-3"></i>
                <p>Welcome to your AI Study Assistant!</p>
                <p>Ask me questions about Mathematics, Science, English, History, and more. You can also upload images for analysis.</p>
            </div>
        `;
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const question = questionInput.value.trim();
        if (!question) {
            alert('Please enter a question.');
            return;
        }

        // Add user message to chat
        addMessage(question, 'user', imageInput.files[0]);
        
        // Show typing indicator
        showTypingIndicator();
        
        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Thinking...';

        // Submit to server
        const formData = new FormData(form);
        
        fetch('{{ url_for("ai_tutor") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideTypingIndicator();
            
            if (data.error) {
                addMessage(`Error: ${data.error}`, 'ai');
            } else {
                addMessage(data.response, 'ai');
            }
        })
        .catch(error => {
            hideTypingIndicator();
            addMessage(`Error: ${error.message}`, 'ai');
        })
        .finally(() => {
            // Reset form
            questionInput.value = '';
            imageInput.value = '';
            clearImagePreview();
            
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Ask AI Tutor';
        });
    });

    function addMessage(content, sender, imageFile = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        let imageHtml = '';
        if (imageFile && sender === 'user') {
            const imageUrl = URL.createObjectURL(imageFile);
            imageHtml = `<div class="message-image"><img src="${imageUrl}" class="image-preview" alt="Uploaded image"></div>`;
        }
        
        // Format AI responses for better readability
        let formattedContent = content;
        if (sender === 'ai') {
            formattedContent = formatAIResponse(content);
        }
        
        messageDiv.innerHTML = `
            ${imageHtml}
            <div class="message-content">${formattedContent}</div>
            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        `;
        
        // Remove welcome message if it exists
        const welcomeMsg = chatContainer.querySelector('.text-center.text-muted');
        if (welcomeMsg) {
            welcomeMsg.remove();
        }
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function formatAIResponse(content) {
        // Format mathematical steps and numbered lists
        let formatted = content
            // Format numbered steps (1., 2., etc.)
            .replace(/^(\d+\.)\s*(.+)$/gm, '<div class="step-item"><span class="step-number">$1</span><span class="step-content">$2</span></div>')
            // Format bullet points
            .replace(/^[-*]\s*(.+)$/gm, '<div class="bullet-item"><i class="fas fa-circle bullet-icon"></i><span class="bullet-content">$1</span></div>')
            // Format mathematical expressions in **bold**
            .replace(/\*\*([^*]+)\*\*/g, '<strong class="math-expression">$1</strong>')
            // Format headers with ##
            .replace(/^##\s*(.+)$/gm, '<h6 class="response-header">$1</h6>')
            // Format code or formulas in backticks
            .replace(/`([^`]+)`/g, '<code class="formula">$1</code>')
            // Add line breaks for paragraphs
            .replace(/\n\n/g, '</div><div class="paragraph">')
            // Format fractions
            .replace(/(\d+)\/(\d+)/g, '<span class="fraction"><sup>$1</sup>&frasl;<sub>$2</sub></span>');
        
        // Wrap in paragraph div if no other formatting
        if (!formatted.includes('<div class="step-item">') && !formatted.includes('<div class="bullet-item">')) {
            formatted = `<div class="paragraph">${formatted}</div>`;
        }
        
        return formatted;
    }

    function showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.innerHTML = '<i class="fas fa-ellipsis-h"></i> AI is thinking...';
        chatContainer.appendChild(indicator);
        indicator.style.display = 'block';
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function hideTypingIndicator() {
        const indicator = chatContainer.querySelector('.typing-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    window.clearImagePreview = function() {
        imagePreviewContainer.innerHTML = '';
        imageInput.value = '';
    };
});
</script>
{% endblock %}